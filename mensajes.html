<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mensajes - Papoclub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: linear-gradient(135deg, #006994, #00b88a);
      color: #0ff;
      font-family: sans-serif;
      margin: 0;
    }

    /* Men√∫ superior fijo */
    .menu-superior {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #011;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 2px 8px #0ff4;
    }

    .menu-superior button {
      background: none;
      border: none;
      color: #0ff;
      font-size: 1.5em;
      cursor: pointer;
      position: relative;
    }

    .menu-superior .alerta {
      position: absolute;
      top: -5px;
      right: -10px;
      background: red;
      color: white;
      font-size: 0.8em;
      border-radius: 50%;
      padding: 0px 5px;
    }

    .panel-central {
      padding: 80px 20px 20px 20px; /* espacio arriba para el men√∫ */
      max-width: 700px;
      margin: auto;
    }

    select, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #0ff;
      background: #011;
      color: #0ff;
    }

    button {
      background: #0ff;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }

    .mensaje-carta {
      background: #011;
      border: 1px solid #0ff;
      border-radius: 12px;
      padding: 10px;
      margin: 10px 0;
      box-shadow: 0 0 10px #0ff6;
    }

    .mensaje-carta h4 {
      margin: 0 0 5px;
      color: #0ff;
    }

    .mensaje-carta p {
      margin: 0;
      color: #0ff;
    }

    .mensaje-carta small {
      display: block;
      margin-top: 5px;
      color: #8ff;
    }
  </style>
</head>
<body>

<!-- Men√∫ superior fijo -->
<div class="menu-superior">
  <button onclick="location.href='home.html'">üè†</button>
  <button onclick="location.href='perfil.html'">üë§</button>
  <button onclick="location.href='historial.html'">üìú</button>
  <button onclick="location.href='mensajes.html'" id="iconoMensaje">‚úâÔ∏è
    <span id="noti" class="alerta" style="display:none;">‚Ä¢</span>
  </button>
  <button onclick="logout()">üö™</button>
</div>

<!-- Contenido principal -->
<div class="panel-central">
  <h2>Enviar mensaje privado</h2>
  <label for="destinatario">Selecciona usuario:</label>
  <select id="destinatario"><option value="">--Seleccionar--</option></select>
  <textarea id="mensaje" rows="3" placeholder="Escribe tu mensaje..."></textarea>
  <button onclick="enviarMensaje()">Enviar</button>
  <div id="cartas"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, query, orderBy,
    onSnapshot, doc, getDoc, getDocs, updateDoc,
    collectionGroup, where
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJmOS9MjDhjJrKCMIUVbgmRiEi2xLIkrQ",
    authDomain: "papoclub-737ac.firebaseapp.com",
    projectId: "papoclub-737ac"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentUsername = null;
  let selectedUser = null;
  let unsubscribe = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "index.html";
    currentUser = user;
    const perfilSnap = await getDoc(doc(db, "users", user.uid));
    if (perfilSnap.exists()) {
      currentUsername = perfilSnap.data().username;
      cargarUsuarios();
      escucharNuevosMensajes();
    }
  });

  window.logout = () => signOut(auth).then(() => location.href = "index.html");

  async function cargarUsuarios() {
    const snap = await getDocs(collection(db, "users"));
    const select = document.getElementById("destinatario");
    snap.forEach(doc => {
      const data = doc.data();
      if (data.username !== currentUsername) {
        const opt = document.createElement("option");
        opt.value = data.username;
        opt.textContent = "@" + data.username;
        select.appendChild(opt);
      }
    });
    select.addEventListener("change", () => {
      selectedUser = select.value;
      if (selectedUser) escucharMensajes(selectedUser);
    });
  }

  function getChatId(a, b) {
    return [a, b].sort().join("_");
  }

  function formatearHora(timestamp) {
    const fecha = new Date(timestamp);
    return fecha.toLocaleString("es-ES", { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
  }

  function escucharMensajes(destino) {
    const chatId = getChatId(currentUsername, destino);
    const mensajesRef = collection(db, "privados", chatId, "mensajes");
    const q = query(mensajesRef, orderBy("timestamp", "asc"));

    if (unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(q, async (snapshot) => {
      const contenedor = document.getElementById("cartas");
      contenedor.innerHTML = "";
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        const carta = document.createElement("div");
        carta.className = "mensaje-carta";
        carta.innerHTML = `
          <h4>${msg.de === currentUsername ? "Yo ‚û°Ô∏è @" + msg.para : "@" + msg.de + " ‚û°Ô∏è Yo"}</h4>
          <p>${msg.texto}</p>
          <small>${formatearHora(msg.timestamp)}</small>
        `;
        contenedor.appendChild(carta);

        if (msg.para === currentUsername && !msg.leido) {
          updateDoc(docSnap.ref, { leido: true }).catch(console.error);
        }
      });
    });
  }

  window.enviarMensaje = async () => {
    const texto = document.getElementById("mensaje").value.trim();
    if (!selectedUser || !texto) return;

    const chatId = getChatId(currentUsername, selectedUser);
    await addDoc(collection(db, "privados", chatId, "mensajes"), {
      de: currentUsername,
      para: selectedUser,
      texto,
      timestamp: Date.now(),
      leido: false
    });

    document.getElementById("mensaje").value = "";
  };

  function escucharNuevosMensajes() {
    const chatsRef = collectionGroup(db, "mensajes");
    const q = query(chatsRef, where("para", "==", currentUsername), where("leido", "==", false));

    onSnapshot(q, (snapshot) => {
      const noti = document.getElementById("noti");
      noti.style.display = snapshot.empty ? "none" : "inline";
    });
  }
</script>
</body>
</html>
