<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil - Papoclub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg, #006994, #00b88a);
      color: #0ff;
      font-family: 'Segoe UI', sans-serif;
    }

    .menu-superior {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #011;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 2px 8px #0ff4;
      z-index: 1000;
    }

    .menu-superior button {
      background: none;
      border: none;
      color: #0ff;
      margin: 0 10px;
      font-size: 1.5em;
      cursor: pointer;
      position: relative;
    }

    .menu-superior .alerta {
      position: absolute;
      top: -5px;
      right: -10px;
      background: red;
      color: white;
      font-size: 0.8em;
      border-radius: 50%;
      padding: 0px 5px;
    }

    .contenido {
      max-width: 600px;
      margin: auto;
      padding: 80px 30px 30px 30px; /* Padding top para men√∫ fijo */
    }

    input {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #0ff;
      background: #011;
      color: #0ff;
    }

    button {
      background: #0ff;
      color: #000;
      font-weight: bold;
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- Men√∫ superior fijo -->
<div class="menu-superior">
  <button onclick="location.href='home.html'">üè†</button>
  <button onclick="location.href='perfil.html'">üë§</button>
  <button onclick="location.href='historial.html'">üìú</button>
  <button onclick="location.href='mensajes.html'" id="iconoMensaje">‚úâÔ∏è
    <span id="noti" class="alerta" style="display:none;">‚Ä¢</span>
  </button>
  <button onclick="logout()">üö™</button>
</div>

<!-- Contenido -->
<div class="contenido">
  <h2>Editar Perfil</h2>
  <label>Nombre de usuario</label>
  <input type="text" id="username" placeholder="Tu nombre de usuario" />
  <label>Email</label>
  <input type="email" id="email" placeholder="Tu correo" disabled />
  <label>URL del avatar</label>
  <input type="text" id="avatarURL" placeholder="https://..." />
  <button onclick="guardarPerfil()">Confirmar</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, collectionGroup, query, where, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJmOS9MjDhjJrKCMIUVbgmRiEi2xLIkrQ",
    authDomain: "papoclub-737ac.firebaseapp.com",
    projectId: "papoclub-737ac"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentUsername = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "index.html";
    currentUser = user;
    document.getElementById("email").value = user.email;

    const docRef = doc(db, "users", user.uid);
    const perfil = await getDoc(docRef);
    if (perfil.exists()) {
      const data = perfil.data();
      document.getElementById("username").value = data.username || "";
      document.getElementById("avatarURL").value = data.avatarURL || "";
      currentUsername = data.username;
      escucharNuevosMensajes();
    }
  });

  window.logout = () => signOut(auth).then(() => location.href = 'index.html');

  window.guardarPerfil = async () => {
    const username = document.getElementById("username").value.trim();
    const avatarURL = document.getElementById("avatarURL").value.trim();
    if (!username) return alert("El nombre de usuario es obligatorio");

    try {
      const docRef = doc(db, "users", currentUser.uid);
      await setDoc(docRef, {
        username,
        email: currentUser.email,
        avatarURL
      });
      alert("Perfil actualizado correctamente.");
    } catch (e) {
      console.error("Error al guardar perfil:", e);
      alert("No se pudo guardar el perfil.");
    }
  };

  function escucharNuevosMensajes() {
    const chatsRef = collectionGroup(db, "mensajes");
    const q = query(chatsRef, where("para", "==", currentUsername), where("leido", "==", false));

    onSnapshot(q, (snapshot) => {
      const noti = document.getElementById("noti");
      noti.style.display = snapshot.empty ? "none" : "inline";
    });
  }
</script>
</body>
</html>
