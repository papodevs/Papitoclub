<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sección Juegos - Papoclub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- Estilos Papoclub con menú 3D fijo arriba --- */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #006994, #00b88a);
      color: #0ff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .menu-superior {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 60px;
      background: linear-gradient(145deg, #00e5ff, #0099cc);
      box-shadow:
        0 0 8px #00e5ffaa,
        0 0 20px #00e5ff88,
        inset 0 2px 6px #00b8d9cc;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #00e5ffcc;
      z-index: 10000;
    }
    .menu-superior button {
      background: none;
      border: none;
      color: #ccf9ff;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 12px;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    .menu-superior button:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 12px #00e5ff, 0 0 30px #00e5ffaa;
    }

    /* --- Layout principal --- */
    .main-layout {
      margin-top: 60px; /* debajo del menu */
      display: flex;
      flex: 1;
      height: calc(100vh - 60px);
      gap: 16px;
      padding: 16px;
      box-sizing: border-box;
    }
    .col-izquierda, .col-centro, .col-derecha {
      background: rgba(0,0,0,0.3);
      border-radius: 14px;
      box-shadow: 0 0 12px #00e5ff88;
      padding: 16px;
      overflow-y: auto;
      color: #0ff;
    }
    .col-izquierda {
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .col-centro {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .col-derecha {
      width: 240px;
    }

    /* --- Formulario --- */
    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    input[type=text], textarea {
      background: #002f36;
      border: none;
      border-radius: 10px;
      padding: 10px;
      color: #0ff;
      font-size: 1rem;
      resize: vertical;
    }
    textarea {
      min-height: 120px;
      font-family: monospace, monospace;
    }
    button.guardar-juego {
      background: #00e5ff;
      color: #003;
      border: none;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button.guardar-juego:hover {
      background: #0099cc;
      color: #0ff;
    }
    /* Lista lateral */
    .lista-juegos-lateral ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .lista-juegos-lateral li {
      padding: 8px 6px;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #003b44;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .lista-juegos-lateral li:hover {
      background: #007f99;
    }
    .lista-juegos-lateral li.active {
      background: #00e5ff;
      color: #003;
      font-weight: 700;
    }

    /* Iframe central */
    #iframeJuego {
      width: 100%;
      height: 100%;
      border-radius: 14px;
      border: none;
      box-shadow: 0 0 20px #00e5ffaa;
      background: #001e22;
    }

    /* Botón "Únete a PapoClub" */
    #btnUnete {
      background: #00e5ff;
      color: #003;
      border: none;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s ease;
      align-self: center;
    }
    #btnUnete:hover {
      background: #0099cc;
      color: #0ff;
    }

    /* Texto para usuarios no autenticados */
    #mensajeNoAuth {
      color: #ccf;
      font-weight: 700;
      font-size: 1.2rem;
      margin-top: 16px;
      text-align: center;
    }

    /* Contenedor para el mensaje de juego no disponible */
    #msgComingSoon {
      color: #66ffff;
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      margin-top: 30px;
      font-style: italic;
    }
  </style>
</head>
<body>

  <div class="menu-superior">
    <button onclick="location.href='home.html'">🏠</button>
    <button onclick="location.href='perfil.html'">👤</button>
    <button onclick="location.href='historial.html'">🎮</button>
    <button onclick="location.href='mensajes.html'">✉️</button>
    <button onclick="logout()">🚪</button>
  </div>

  <div class="main-layout">
    <!-- Col Izquierda: Formulario -->
    <div class="col-izquierda" id="colIzquierda">
      <!-- Si usuario no autenticado se ocultará -->
      <form id="formularioJuego" style="display:none;">
        <h2>Crear Nuevo Juego</h2>
        <input type="text" id="nombreJuego" placeholder="Nombre del juego" required />
        <input type="text" id="imagenJuego" placeholder="URL de imagen" required />
        <input type="text" id="paginaJuego" placeholder="Página del juego (opcional)" />
        <input type="text" id="telegramJuego" placeholder="Canal de Telegram (opcional)" />
        <input type="text" id="discordJuego" placeholder="Servidor de Discord (opcional)" />
        <textarea id="codigoHTMLJuego" placeholder="Código HTML del juego (solo para borincanopr)"></textarea>
        <button type="submit" class="guardar-juego">Guardar Juego</button>
      </form>

      <!-- Mensaje para usuarios no autenticados -->
      <div id="mensajeNoAuth" style="display:none;">
        <p>Debes iniciar sesión para crear juegos.</p>
        <button id="btnUnete" onclick="location.href='index.html'">Únete a PapoClub</button>
      </div>
    </div>

    <!-- Col Centro: Iframe para jugar -->
    <div class="col-centro">
      <iframe id="iframeJuego" src="" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
      <div id="msgComingSoon" style="display:none;">Coming Soon MuzzGalaxy game</div>
    </div>

    <!-- Col Derecha: Lista juegos -->
    <div class="col-derecha lista-juegos-lateral">
      <h3>🎮 Juegos Publicados</h3>
      <ul id="listaJuegos"></ul>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJmOS9MjDhjJrKCMIUVbgmRiEi2xLIkrQ",
    authDomain: "papoclub-737ac.firebaseapp.com",
    projectId: "papoclub-737ac",
    storageBucket: "papoclub-737ac.appspot.com",
    messagingSenderId: "76712370993",
    appId: "1:76712370993:web:2d2646b258efbccf68c73e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  let juegos = [];
  let juegoSeleccionadoId = null;

  // UID or email identificador del admin que puede editar el código HTML del juego
  const ADMIN_EMAIL = "borincano@gmail.com"; // Cambiar si prefieres UID usar user.uid

  // Actualiza vista iframe o mensaje "Coming Soon"
  function mostrarJuego(juego) {
    const iframe = document.getElementById("iframeJuego");
    const msgComing = document.getElementById("msgComingSoon");

    if (juego.codigoHTML && juego.codigoHTML.trim().length > 0) {
      // Si usuario admin puede editar el juego en iframe con srcdoc
      if (currentUser && currentUser.email === ADMIN_EMAIL) {
        iframe.style.display = "block";
        msgComing.style.display = "none";
        iframe.srcdoc = juego.codigoHTML;
      } else {
        // Para otros usuarios solo mostramos juego en iframe, sin editar
        iframe.style.display = "block";
        msgComing.style.display = "none";
        iframe.srcdoc = juego.codigoHTML;
      }
    } else {
      iframe.style.display = "none";
      msgComing.style.display = "block";
    }
  }

  // Cargar juegos y actualizar listas
  function cargarJuegos() {
    const q = query(collection(db, "juegos"), orderBy("fecha", "desc"));
    const ulLista = document.getElementById("listaJuegos");

    onSnapshot(q, (snapshot) => {
      juegos = [];
      ulLista.innerHTML = "";
      juegoSeleccionadoId = null;
      document.getElementById("iframeJuego").srcdoc = "";
      document.getElementById("msgComingSoon").style.display = "none";

      snapshot.forEach((docSnap) => {
        const juego = docSnap.data();
        juego.id = docSnap.id;
        juegos.push(juego);

        const li = document.createElement("li");
        li.textContent = juego.nombre;
        li.dataset.id = juego.id;

        li.onclick = () => {
          // Remover active
          Array.from(ulLista.children).forEach(liEl => liEl.classList.remove("active"));
          li.classList.add("active");

          juegoSeleccionadoId = juego.id;
          mostrarJuego(juego);
          mostrarFormularioSegunPermisos(juego);
        };
        ulLista.appendChild(li);
      });
    });
  }

  // Mostrar/Ocultar formulario según permisos
  function mostrarFormularioSegunPermisos(juego) {
    const form = document.getElementById("formularioJuego");
    const noAuthMsg = document.getElementById("mensajeNoAuth");

    if (!currentUser) {
      form.style.display = "none";
      noAuthMsg.style.display = "block";
      return;
    }

    noAuthMsg.style.display = "none";

    // Solo admin puede editar el código HTML del juego seleccionado
    if (currentUser.email === ADMIN_EMAIL && juego && juego.creadorUID === currentUser.uid) {
      form.style.display = "flex";

      // Rellenar formulario con datos del juego seleccionado
      document.getElementById("nombreJuego").value = juego.nombre || "";
      document.getElementById("imagenJuego").value = juego.imagen || "";
      document.getElementById("paginaJuego").value = juego.pagina || "";
      document.getElementById("telegramJuego").value = juego.telegram || "";
      document.getElementById("discordJuego").value = juego.discord || "";
      document.getElementById("codigoHTMLJuego").value = juego.codigoHTML || "";

    } else {
      // Para otros usuarios no mostrar formulario de edición
      form.style.display = "none";
    }
  }

  // Guardar juego: crea o actualiza (solo admin)
  async function guardarJuego(event) {
    event.preventDefault();

    if (!currentUser) {
      alert("Debes iniciar sesión para guardar un juego.");
      return;
    }
    if (currentUser.email !== ADMIN_EMAIL) {
      alert("No tienes permisos para editar juegos.");
      return;
    }
    if (!juegoSeleccionadoId) {
      alert("Selecciona un juego para editar o crea uno nuevo.");
      return;
    }

    const nombre = document.getElementById("nombreJuego").value.trim();
    const imagen = document.getElementById("imagenJuego").value.trim();
    const pagina = document.getElementById("paginaJuego").value.trim();
    const telegram = document.getElementById("telegramJuego").value.trim();
    const discord = document.getElementById("discordJuego").value.trim();
    const codigoHTML = document.getElementById("codigoHTMLJuego").value;

    if (!nombre || !imagen) {
      alert("Nombre y URL de imagen son obligatorios.");
      return;
    }

    try {
      await updateDoc(doc(db, "juegos", juegoSeleccionadoId), {
        nombre,
        imagen,
        pagina,
        telegram,
        discord,
        codigoHTML,
        fecha: new Date()
      });
      alert("Juego actualizado con éxito.");
    } catch (error) {
      alert("Error al actualizar juego: " + error.message);
    }
  }

  // Crear nuevo juego (solo admin)
  async function crearNuevoJuego() {
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) return;

    const nombre = document.getElementById("nombreJuego").value.trim();
    const imagen = document.getElementById("imagenJuego").value.trim();
    const pagina = document.getElementById("paginaJuego").value.trim();
    const telegram = document.getElementById("telegramJuego").value.trim();
    const discord = document.getElementById("discordJuego").value.trim();
    const codigoHTML = document.getElementById("codigoHTMLJuego").value;

    if (!nombre || !imagen) {
      alert("Nombre y URL de imagen son obligatorios.");
      return;
    }

    try {
      const docRef = await addDoc(collection(db, "juegos"), {
        creadorUID: currentUser.uid,
        nombre,
        imagen,
        pagina,
        telegram,
        discord,
        codigoHTML,
        fecha: new Date()
      });
      alert("Juego creado con éxito.");
      // Limpia formulario después
      document.getElementById("nombreJuego").value = "";
      document.getElementById("imagenJuego").value = "";
      document.getElementById("paginaJuego").value = "";
      document.getElementById("telegramJuego").value = "";
      document.getElementById("discordJuego").value = "";
      document.getElementById("codigoHTMLJuego").value = "";
      // Selecciona el nuevo juego para editar
      juegoSeleccionadoId = docRef.id;
      cargarJuegos(); // recarga lista
    } catch (error) {
      alert("Error al crear juego: " + error.message);
    }
  }

  // Manejo del formulario submit (distinguir crear o actualizar)
  document.getElementById("formularioJuego").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!juegoSeleccionadoId) {
      // Crear nuevo juego
      await crearNuevoJuego();
    } else {
      // Actualizar juego existente
      await guardarJuego(e);
    }
  });

  // Verifica autenticación y muestra formulario o mensaje unirse
  onAuthStateChanged(auth, (user) => {
    currentUser = user;

    const form = document.getElementById("formularioJuego");
    const noAuthMsg = document.getElementById("mensajeNoAuth");

    if (!user) {
      form.style.display = "none";
      noAuthMsg.style.display = "block";
    } else {
      noAuthMsg.style.display = "none";
      // Si el usuario es admin y no hay juego seleccionado, mostrar formulario vacío para crear
      if (user.email === ADMIN_EMAIL && !juegoSeleccionadoId) {
        form.style.display = "flex";
        document.getElementById("nombreJuego").value = "";
        document.getElementById("imagenJuego").value = "";
        document.getElementById("paginaJuego").value = "";
        document.getElementById("telegramJuego").value = "";
        document.getElementById("discordJuego").value = "";
        document.getElementById("codigoHTMLJuego").value = "";
      }
    }
    cargarJuegos();
  });

  // Logout función
  window.logout = () => {
    signOut(auth).then(() => {
      location.href = "index.html";
    });
  };
</script>

</body>
</html>
