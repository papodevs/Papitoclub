<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Papoclub - Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: linear-gradient(135deg, #006994, #00b88a);
      color: #0ff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding-top: 70px;
    }

    .menu-superior {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: linear-gradient(145deg, #00e5ff, #0099cc);
      box-shadow: 0 0 8px #00e5ffaa, 0 0 20px #00e5ff88, inset 0 2px 6px #00b8d9cc;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      padding-right: 12px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #00e5ffcc;
    }

    .menu-superior button {
      background: none;
      border: none;
      color: #ccf9ff;
      font-size: 1.4em;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 12px;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      position: relative;
    }

    .menu-superior button:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 12px #00e5ff, 0 0 30px #00e5ffaa;
    }

    .alerta {
      position: absolute;
      top: 4px;
      right: 4px;
      background: red;
      color: white;
      font-size: 0.7em;
      border-radius: 50%;
      padding: 2px 5px;
      display: none;
    }

    .contenedor {
      max-width: 600px;
      margin: auto;
      padding: 1em;
    }

    .nueva-publicacion {
      background: rgba(0,0,0,0.2);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 0 10px #00e5ff55;
    }

    .nueva-publicacion textarea {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: none;
      padding: 10px;
      font-size: 1em;
      resize: none;
      background: #002f36;
      color: #0ff;
    }

    .nueva-publicacion button {
      margin-top: 8px;
      background: #00e5ff;
      color: #003;
      border: none;
      padding: 10px 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
    }

    .tarjeta {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 14px;
      box-shadow: 0 0 6px #00e5ff44;
    }

    .tarjeta-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .tarjeta-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #00e5ff;
      object-fit: cover;
    }

    .tarjeta-header strong {
      color: #00e5ff;
      font-weight: bold;
      font-size: 1.1em;
    }

    .tarjeta p {
      margin: 6px 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .interacciones {
      display: flex;
      justify-content: space-around;
      margin-top: 8px;
      font-size: 0.9em;
      color: #0ff;
    }

    .interacciones span {
      cursor: pointer;
      transition: 0.3s;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .interacciones span.liked,
    .interacciones span.repaped {
      color: #ff3399;
      text-shadow: 0 0 8px #ff3399;
      font-weight: bold;
    }

    .interacciones span:hover {
      color: #fff;
      text-shadow: 0 0 12px #0ff;
    }

    .comentarios-container {
      margin-top: 12px;
      padding-left: 20px;
      border-left: 2px solid #00e5ff66;
    }

    .comentario {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      box-shadow: 0 0 8px #00e5ff44;
    }

    .comentario-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .comentario-header img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1.5px solid #00e5ff;
      object-fit: cover;
    }

    .comentario-header strong {
      color: #00e5ff;
      font-size: 0.95em;
    }

    .comentario-text {
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 6px;
    }

    .interacciones-comentario {
      display: flex;
      gap: 12px;
      font-size: 0.8em;
      color: #0ff;
      user-select: none;
    }

    .interacciones-comentario span {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: color 0.3s;
    }

    .interacciones-comentario span.liked,
    .interacciones-comentario span.repaped {
      color: #ff3399;
      text-shadow: 0 0 8px #ff3399;
      font-weight: bold;
    }

    .interacciones-comentario span:hover {
      color: #fff;
      text-shadow: 0 0 12px #0ff;
    }

    .textarea-comentario {
      width: 100%;
      border-radius: 8px;
      border: none;
      padding: 6px;
      margin-top: 6px;
      background: #002f36;
      color: #0ff;
      resize: none;
    }

  </style>
</head>
<body>
  <div class="menu-superior">
    <button onclick="location.href='home.html'">üè†</button>
    <button onclick="location.href='perfil.html'">üë§</button>
    <button onclick="location.href='historial.html'">üéÆ</button>
    <button onclick="location.href='mensajes.html'">‚úâÔ∏è</button>
    <button onclick="logout()">üö™</button>
  </div>

  <div class="contenedor">
    <div class="nueva-publicacion">
      <textarea id="nuevoMensaje" placeholder="¬øQu√© est√°s pensando?"></textarea>
      <button onclick="publicarMensaje()">Publicar</button>
    </div>

    <div id="listaMensajes"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy,
      doc, updateDoc, arrayUnion, arrayRemove, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCJmOS9MjDhjJrKCMIUVbgmRiEi2xLIkrQ",
      authDomain: "papoclub-737ac.firebaseapp.com",
      projectId: "papoclub-737ac",
      storageBucket: "papoclub-737ac.appspot.com",
      messagingSenderId: "76712370993",
      appId: "1:76712370993:web:2d2646b258efbccf68c73e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    // Publicar un nuevo post
    async function publicarMensaje() {
      const texto = document.getElementById("nuevoMensaje").value.trim();
      if (!texto) return alert("Escribe algo para publicar.");
      if (!currentUser) return alert("Debes iniciar sesi√≥n.");

      const nuevoPost = {
        texto,
        autorUID: currentUser.uid,
        fecha: new Date(),
        likeUIDs: [],
        repaposUIDs: []
      };

      await addDoc(collection(db, "publicaciones"), nuevoPost);
      document.getElementById("nuevoMensaje").value = "";
    }

    // Funci√≥n para crear tarjeta de comentario
    async function crearTarjetaComentario(postId, comentarioData, comentarioId) {
      const cont = document.createElement("div");
      cont.className = "comentario";

      // Obtener datos de usuario autor comentario
      let avatar = "";
      let nickname = "Usuario";
      try {
        const userSnap = await getDoc(doc(db, "users", comentarioData.autorUID));
        if (userSnap.exists()) {
          const dataUser = userSnap.data();
          avatar = dataUser.avatar || "";
          nickname = dataUser.nickname || nickname;
        }
      } catch {}

      const likeCount = comentarioData.likeUIDs ? comentarioData.likeUIDs.length : 0;
      const repapoCount = comentarioData.repaposUIDs ? comentarioData.repaposUIDs.length : 0;
      const userLiked = comentarioData.likeUIDs && comentarioData.likeUIDs.includes(currentUser.uid);
      const userRepaped = comentarioData.repaposUIDs && comentarioData.repaposUIDs.includes(currentUser.uid);

      cont.innerHTML = `
        <div class="comentario-header" onclick="mostrarPerfil('${nickname}', '${comentarioData.autorUID}')">
          <img src="${avatar}" alt="avatar" />
          <strong>${nickname}</strong>
        </div>
        <div class="comentario-text">${comentarioData.texto}</div>
        <div class="interacciones-comentario">
          <span class="like-comentario ${userLiked ? 'liked' : ''}" onclick="toggleLikeComentario(event, '${postId}', '${comentarioId}')">‚ù§Ô∏è ${likeCount}</span>
          <span class="repapo-comentario ${userRepaped ? 'repaped' : ''}" onclick="toggleRepapoComentario(event, '${postId}', '${comentarioId}')">üîÅ ${repapoCount}</span>
        </div>
      `;

      return cont;
    }

    // Crear tarjeta post con comentarios
    async function crearTarjetaPost(postId, data) {
      const tarjeta = document.createElement("div");
      tarjeta.className = "tarjeta";

      // Obtener usuario autor
      let avatar = "";
      let nickname = "Usuario";
      try {
        const userSnap = await getDoc(doc(db, "users", data.autorUID));
        if (userSnap.exists()) {
          const dataUser = userSnap.data();
          avatar = dataUser.avatar || "";
          nickname = dataUser.nickname || nickname;
        }
      } catch {}

      // Contar likes y repapos
      const likeCount = data.likeUIDs ? data.likeUIDs.length : 0;
      const repapoCount = data.repaposUIDs ? data.repaposUIDs.length : 0;
      const userLiked = data.likeUIDs && data.likeUIDs.includes(currentUser.uid);
      const userRepaped = data.repaposUIDs && data.repaposUIDs.includes(currentUser.uid);

      // Crear contenedor para comentarios y textarea oculto
      const comentariosContenedor = document.createElement("div");
      comentariosContenedor.className = "comentarios-container";

      const textareaComentario = document.createElement("textarea");
      textareaComentario.className = "textarea-comentario";
      textareaComentario.placeholder = "Escribe un comentario...";
      textareaComentario.style.display = "none";

      const botonEnviarComentario = document.createElement("button");
      botonEnviarComentario.textContent = "Enviar comentario";
      botonEnviarComentario.style.display = "none";

      // Mostrar/ocultar textarea y bot√≥n al click en comentar
      function toggleComentario() {
        if (textareaComentario.style.display === "none") {
          textareaComentario.style.display = "block";
          botonEnviarComentario.style.display = "inline-block";
          textareaComentario.focus();
        } else {
          textareaComentario.style.display = "none";
          botonEnviarComentario.style.display = "none";
          textareaComentario.value = "";
        }
      }

      // Enviar comentario a Firestore
      botonEnviarComentario.addEventListener("click", async () => {
        const texto = textareaComentario.value.trim();
        if (!texto) return alert("Escribe un comentario.");
        const comentario = {
          texto,
          autorUID: currentUser.uid,
          fecha: new Date(),
          likeUIDs: [],
          repaposUIDs: []
        };
        await addDoc(collection(db, "publicaciones", postId, "comentarios"), comentario);
        textareaComentario.value = "";
        textareaComentario.style.display = "none";
        botonEnviarComentario.style.display = "none";
      });

      // Cabecera con avatar y nickname clickeable para perfil p√∫blico
      tarjeta.innerHTML = `
        <div class="tarjeta-header" onclick="mostrarPerfil('${nickname}', '${data.autorUID}')">
          <img src="${avatar}" alt="avatar" />
          <strong>${nickname}</strong>
        </div>
        <p>${data.texto}</p>
        <div class="interacciones">
          <span class="like-post ${userLiked ? 'liked' : ''}" onclick="toggleLike(event, '${postId}')">‚ù§Ô∏è ${likeCount}</span>
          <span class="repapo-post ${userRepaped ? 'repaped' : ''}" onclick="toggleRepapo(event, '${postId}')">üîÅ ${repapoCount}</span>
          <span class="comment-post" onclick="toggleComentario()">üí¨ comment</span>
          <span class="share-post" onclick="sharePost('${encodeURIComponent(data.texto)}')">üì§ share</span>
        </div>
      `;

      tarjeta.appendChild(textareaComentario);
      tarjeta.appendChild(botonEnviarComentario);
      tarjeta.appendChild(comentariosContenedor);

      // Cargar comentarios en tiempo real
      const qComentarios = query(collection(db, "publicaciones", postId, "comentarios"), orderBy("fecha", "asc"));
      onSnapshot(qComentarios, async (snapshot) => {
        comentariosContenedor.innerHTML = "";
        for (const docu of snapshot.docs) {
          const comentData = docu.data();
          const comentId = docu.id;
          const comentTarjeta = await crearTarjetaComentario(postId, comentData, comentId);
          comentariosContenedor.appendChild(comentTarjeta);
        }
      });

      return tarjeta;
    }

    // Toggle like post
    async function toggleLike(event, postId) {
      event.stopPropagation();
      const docRef = doc(db, "publicaciones", postId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const likeUIDs = data.likeUIDs || [];
      const userHasLiked = likeUIDs.includes(currentUser.uid);
      if (userHasLiked) {
        await updateDoc(docRef, { likeUIDs: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(docRef, { likeUIDs: arrayUnion(currentUser.uid) });
      }
    }

    // Toggle repapo post
    async function toggleRepapo(event, postId) {
      event.stopPropagation();
      const docRef = doc(db, "publicaciones", postId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const repaposUIDs = data.repaposUIDs || [];
      const userHasRepaped = repaposUIDs.includes(currentUser.uid);
      if (userHasRepaped) {
        await updateDoc(docRef, { repaposUIDs: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(docRef, { repaposUIDs: arrayUnion(currentUser.uid) });
      }
    }

    // Toggle like comentario
    async function toggleLikeComentario(event, postId, comentarioId) {
      event.stopPropagation();
      const docRef = doc(db, "publicaciones", postId, "comentarios", comentarioId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const likeUIDs = data.likeUIDs || [];
      const userHasLiked = likeUIDs.includes(currentUser.uid);
      if (userHasLiked) {
        await updateDoc(docRef, { likeUIDs: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(docRef, { likeUIDs: arrayUnion(currentUser.uid) });
      }
    }

    // Toggle repapo comentario
    async function toggleRepapoComentario(event, postId, comentarioId) {
      event.stopPropagation();
      const docRef = doc(db, "publicaciones", postId, "comentarios", comentarioId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const repaposUIDs = data.repaposUIDs || [];
      const userHasRepaped = repaposUIDs.includes(currentUser.uid);
      if (userHasRepaped) {
        await updateDoc(docRef, { repaposUIDs: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(docRef, { repaposUIDs: arrayUnion(currentUser.uid) });
      }
    }

    // Mostrar perfil p√∫blico al hacer click en avatar o nickname
    function mostrarPerfil(nick, uid) {
      window.location.href = `perfil.html?id=${uid}`;
    }

    // Compartir post usando Web Share API si disponible o fallback copiar texto
    async function sharePost(texto) {
      const decodedText = decodeURIComponent(texto);
      if (navigator.share) {
        try {
          await navigator.share({
            title: "Papoclub",
            text: decodedText,
            url: window.location.href
          });
        } catch (err) {
          alert("Error al compartir: " + err);
        }
      } else {
        // fallback copiar al portapapeles
        try {
          await navigator.clipboard.writeText(decodedText);
          alert("Texto copiado al portapapeles para compartir.");
        } catch {
          alert("No se pudo acceder al portapapeles.");
        }
      }
    }

    // Logout
    function logout() {
      signOut(auth).then(() => location.href = "index.html");
    }
    window.logout = logout;

    // Carga inicial y escucha en tiempo real de posts
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Debes iniciar sesi√≥n.");
        location.href = "index.html";
        return;
      }
      currentUser = user;

      const q = query(collection(db, "publicaciones"), orderBy("fecha", "desc"));
      onSnapshot(q, async (snapshot) => {
        const lista = document.getElementById("listaMensajes");
        lista.innerHTML = "";
        for (const docu of snapshot.docs) {
          const data = docu.data();
          const id = docu.id;
          const tarjeta = await crearTarjetaPost(id, data);
          lista.appendChild(tarjeta);
        }
      });
    });
  </script>
</body>
</html>
